name: Isaac Arena CI

on:
  pull_request:
  push:
    branches: [ "main" ]

# Concurrency control to prevent parallel runs on the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write
  issues: read

env:
  NGC_API_KEY: ${{ secrets.ARENA_NGC_API_KEY }}
  CONTAINER_IMAGE: nvcr.io/nvstaging/isaac-amr/isaac_arena:latest

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest

    steps:
      # Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
            fetch-depth: 0

      - name: NGC Login
        run: docker login nvcr.io -u '$oauthtoken' -p ${{ env.NGC_API_KEY }}

      - name: Run in container
        run: |
          docker run --rm \
            -v $PWD:/workspace \
            -w /workspace \
            $CONTAINER_IMAGE \
            bash -c "
              apt-get update && apt-get install -y --no-install-recommends git clang-format &&
              pip install --no-cache-dir --upgrade pip &&
              pip install --no-cache-dir pre-commit &&
              pre-commit run --all-files &&
              /isaac-sim/python.sh -m pytest -sv isaac_arena/tests
            "
